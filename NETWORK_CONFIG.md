# Сетевая конфигурация CPSS

## Обзор

Система CPSS использует порты в диапазоне **1000-2000** и поддерживает настройку через переменные окружения Docker.

## IP адреса

### Внешний IP: 78.107.254.30
### Локальный IP: 192.168.88.50

## Порты по умолчанию

Все порты настраиваются в файле `.env`:

| Сервис | Порт по умолчанию | Переменная окружения |
|--------|-------------------|----------------------|
| Frontend (веб-интерфейс) | 1800 | `FRONTEND_PORT` |
| Backend API | 1800 | `BACKEND_PORT` |
| PostgreSQL | 1543 | `POSTGRES_PORT` |
| Redis | 1637 | `REDIS_PORT` |

**Важно:** Все порты должны быть в диапазоне **1000-2000**.

## Конфигурация

### 1. Базовая настройка

Создайте файл `.env` на основе `env.example.txt`:

```bash
cp env.example.txt .env
```

### 2. Настройка IP адресов

В `.env` укажите `HOST_IP`:

```env
# Все интерфейсы (рекомендуется)
HOST_IP=0.0.0.0

# Только внешний IP
HOST_IP=78.107.254.30

# Только локальный IP
HOST_IP=192.168.88.50
```

### 3. Настройка портов

```env
# Измените порты если нужно (в диапазоне 1000-2000)
FRONTEND_PORT=1800
BACKEND_PORT=1800
POSTGRES_PORT=1543
REDIS_PORT=1637
```

### 4. Настройка CORS

Укажите все адреса, с которых будет доступ к системе:

```env
CORS_ORIGINS=http://78.107.254.30:1800,http://192.168.88.50:1800,http://localhost:1800
```

## Доступ к системе

После настройки и запуска система будет доступна:

### Внешний доступ
- **Веб-интерфейс:** http://78.107.254.30:1800
- **API:** http://78.107.254.30:1800/api
- **API Docs:** http://78.107.254.30:1800/api/docs

### Локальный доступ
- **Веб-интерфейс:** http://192.168.88.50:1800
- **API:** http://192.168.88.50:1800/api
- **API Docs:** http://192.168.88.50:1800/api/docs

## Проверка портов

Перед запуском проверьте, что порты свободны:

```bash
# Проверка всех портов
sudo netstat -tulpn | grep -E ':(1543|1637|1800)'

# Или с помощью ss
sudo ss -tulpn | grep -E ':(1543|1637|1800)'
```

Если порты заняты, измените их в `.env`.

## Firewall настройки

### Ubuntu/Debian (ufw)

```bash
# Разрешить порты
sudo ufw allow 1800/tcp comment "CPSS Frontend/Backend"
sudo ufw allow 1543/tcp comment "CPSS PostgreSQL"
sudo ufw allow 1637/tcp comment "CPSS Redis"

# Проверить статус
sudo ufw status
```

### CentOS/RHEL (firewalld)

```bash
# Разрешить порты
sudo firewall-cmd --permanent --add-port=1800/tcp
sudo firewall-cmd --permanent --add-port=1543/tcp
sudo firewall-cmd --permanent --add-port=1637/tcp

# Применить изменения
sudo firewall-cmd --reload

# Проверить статус
sudo firewall-cmd --list-all
```

### iptables

```bash
# Разрешить порты
sudo iptables -A INPUT -p tcp --dport 1800 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 1543 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 1637 -j ACCEPT

# Сохранить правила (Ubuntu/Debian)
sudo iptables-save > /etc/iptables/rules.v4
```

## Пример полной конфигурации .env

```env
# ============================================
# СЕТЕВЫЕ НАСТРОЙКИ
# ============================================
HOST_IP=0.0.0.0
FRONTEND_PORT=1800
BACKEND_PORT=1800
POSTGRES_PORT=1543
REDIS_PORT=1637

# CORS - разрешенные источники
CORS_ORIGINS=http://78.107.254.30:1800,http://192.168.88.50:1800,http://localhost:1800

# ============================================
# БЕЗОПАСНОСТЬ
# ============================================
ADMIN_PASSWORD=ваш_надежный_пароль
SECRET_KEY=случайная_строка_32_символа

# ============================================
# БАЗА ДАННЫХ
# ============================================
DB_USER=cpss_user
DB_PASSWORD=надежный_пароль_БД

# ============================================
# БОТЫ
# ============================================
TELEGRAM_TOKEN=ваш_токен_telegram
DISCORD_TOKEN=ваш_токен_discord

# ============================================
# FRONTEND
# ============================================
REACT_APP_API_URL=/api
REACT_APP_BACKEND_URL=http://78.107.254.30:1800
```

## Устранение проблем

### Порт уже используется

Если порт занят, измените его в `.env` на другой из диапазона 1000-2000:

```env
FRONTEND_PORT=1900  # Вместо 1800
```

### Не могу подключиться по внешнему IP

1. Проверьте `HOST_IP` в `.env` (должен быть `0.0.0.0` или `78.107.254.30`)
2. Проверьте firewall настройки
3. Проверьте, что порты открыты в провайдере/VPS панели
4. Проверьте логи: `docker-compose logs frontend`

### Ошибки CORS в браузере

Убедитесь, что в `CORS_ORIGINS` указан правильный адрес:

```env
CORS_ORIGINS=http://78.107.254.30:1800,http://192.168.88.50:1800
```

После изменения перезапустите сервисы:

```bash
docker-compose restart backend
```

## Диаграмма портов

```
┌─────────────────────────────────────────┐
│          Сервер (78.107.254.30)         │
│                                         │
│  ┌──────────┐  ┌──────────┐            │
│  │ Frontend │  │ Backend  │            │
│  │  :1800   │  │  :1800   │            │
│  └────┬─────┘  └────┬─────┘            │
│       │             │                   │
│       └──────┬──────┘                   │
│              │                          │
│  ┌───────────▼───────────┐             │
│  │  PostgreSQL  :1543    │             │
│  │  Redis       :1637    │             │
│  └───────────────────────┘             │
└─────────────────────────────────────────┘
         ▲
         │
    Доступ извне
```

## Дополнительные ресурсы

- [DEPLOYMENT.md](./DEPLOYMENT.md) - Полное руководство по развертыванию
- [README.md](./README.md) - Общая информация о проекте

