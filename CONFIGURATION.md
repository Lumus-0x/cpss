# Руководство по конфигурации CPSS

## Обзор

Все настройки системы CPSS настраиваются через переменные окружения в файле `.env`. Система использует порты в диапазоне **1000-2000** и поддерживает хостинг на внешнем IP **78.107.254.30** и локальном IP **192.168.88.50**.

## Быстрая настройка

1. Скопируйте пример конфигурации:
```bash
cp env.example.txt .env
```

2. Отредактируйте `.env` и укажите ваши значения

3. Запустите систему:
```bash
docker-compose up -d
```

## Переменные окружения

### Сетевые настройки

| Переменная | Описание | По умолчанию | Пример |
|------------|----------|--------------|--------|
| `HOST_IP` | IP для привязки сервисов | `0.0.0.0` | `78.107.254.30` |
| `FRONTEND_PORT` | Порт веб-интерфейса | `1800` | `1900` |
| `BACKEND_PORT` | Порт API Backend | `1800` | `1900` |
| `POSTGRES_PORT` | Порт PostgreSQL | `1543` | `1543` |
| `REDIS_PORT` | Порт Redis | `1637` | `1637` |

**Важно:** Все порты должны быть в диапазоне 1000-2000.

### Безопасность

| Переменная | Описание | Обязательно | Пример |
|------------|----------|-------------|--------|
| `ADMIN_PASSWORD` | Пароль администратора | Да | `mySecurePass123!` |
| `SECRET_KEY` | Секретный ключ для JWT | Да | `openssl rand -hex 32` |
| `CORS_ORIGINS` | Разрешенные источники (через запятую) | Нет | `http://78.107.254.30:1800` |

### База данных

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `DB_USER` | Пользователь БД | `cpss_user` |
| `DB_PASSWORD` | Пароль БД | `secure_db_password` |

### Боты

| Переменная | Описание | Обязательно |
|------------|----------|-------------|
| `TELEGRAM_TOKEN` | Токен Telegram бота | Да |
| `DISCORD_TOKEN` | Токен Discord бота | Да |

### Frontend

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `REACT_APP_API_URL` | URL API для фронтенда | `/api` |
| `REACT_APP_BACKEND_URL` | Полный URL бэкенда | `http://78.107.254.30:1800` |

## Пример конфигурации для вашего сервера

```env
# ============================================
# СЕТЕВЫЕ НАСТРОЙКИ
# ============================================
# Привязка ко всем интерфейсам
HOST_IP=0.0.0.0

# Порты (диапазон 1000-2000)
FRONTEND_PORT=1800
BACKEND_PORT=1800
POSTGRES_PORT=1543
REDIS_PORT=1637

# CORS - все адреса для доступа
CORS_ORIGINS=http://78.107.254.30:1800,http://192.168.88.50:1800,http://localhost:1800

# ============================================
# БЕЗОПАСНОСТЬ
# ============================================
# Сгенерируйте надежный пароль
ADMIN_PASSWORD=your_very_secure_password_here

# Сгенерируйте секретный ключ: openssl rand -hex 32
SECRET_KEY=your_32_character_secret_key_here

# ============================================
# БАЗА ДАННЫХ
# ============================================
DB_USER=cpss_user
DB_PASSWORD=secure_database_password_here

# ============================================
# БОТЫ
# ============================================
TELEGRAM_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
DISCORD_TOKEN=MTIzNDU2Nzg5MDEyMzQ1Njc4OQ.AbCdEf.GhIjKlMnOpQrStUvWxYzAbCdEfGhIjKl

# ============================================
# FRONTEND (опционально)
# ============================================
REACT_APP_API_URL=/api
REACT_APP_BACKEND_URL=http://78.107.254.30:1800
```

## Генерация безопасных значений

### Генерация SECRET_KEY

```bash
# Linux/Mac
openssl rand -hex 32

# Или Python
python -c "import secrets; print(secrets.token_hex(32))"
```

### Генерация пароля

```bash
# Linux/Mac
openssl rand -base64 32

# Или Python
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

## Изменение портов

Если стандартные порты заняты, измените их в `.env`:

```env
# Пример: использование других портов
FRONTEND_PORT=1900
BACKEND_PORT=1900
POSTGRES_PORT=1543
REDIS_PORT=1637
```

После изменения портов:

1. Обновите `CORS_ORIGINS`:
```env
CORS_ORIGINS=http://78.107.254.30:1900,http://192.168.88.50:1900
```

2. Перезапустите сервисы:
```bash
docker-compose down
docker-compose up -d
```

3. Обновите firewall правила (если нужно)

## Привязка к конкретному IP

### Только внешний IP

```env
HOST_IP=78.107.254.30
```

### Только локальный IP

```env
HOST_IP=192.168.88.50
```

### Все интерфейсы (рекомендуется)

```env
HOST_IP=0.0.0.0
```

## Проверка конфигурации

После настройки `.env` проверьте конфигурацию:

```bash
# Проверка синтаксиса docker-compose
docker-compose config

# Проверка доступности портов
sudo netstat -tulpn | grep -E ':(1543|1637|1800)'
```

## Применение изменений

После изменения `.env`:

1. Перезапустите сервисы:
```bash
docker-compose restart
```

2. Или полностью пересоздайте:
```bash
docker-compose down
docker-compose up -d
```

## Безопасность

### Рекомендации

1. **Никогда не коммитьте `.env` в Git**
   - Файл уже добавлен в `.gitignore`

2. **Используйте надежные пароли**
   - Минимум 16 символов
   - Комбинация букв, цифр, символов

3. **Регулярно меняйте SECRET_KEY**
   - После смены все пользователи должны перелогиниться

4. **Ограничьте доступ к портам БД**
   - PostgreSQL и Redis не должны быть доступны извне
   - Используйте firewall правила

5. **Настройте CORS правильно**
   - Укажите только необходимые домены/IP
   - Не используйте `*` в продакшене

## Устранение проблем

### Переменные не применяются

1. Проверьте синтаксис `.env`:
   ```bash
   # Не должно быть пробелов вокруг =
   CORRECT: VAR=value
   WRONG: VAR = value
   ```

2. Перезапустите сервисы после изменения:
   ```bash
   docker-compose restart
   ```

### Порт уже используется

```bash
# Найти процесс, использующий порт
sudo lsof -i :1800

# Изменить порт в .env на другой
FRONTEND_PORT=1900
```

### CORS ошибки

Убедитесь, что в `CORS_ORIGINS` указан правильный адрес:

```env
CORS_ORIGINS=http://78.107.254.30:1800
```

После изменения перезапустите backend:
```bash
docker-compose restart backend
```

## Дополнительные ресурсы

- [NETWORK_CONFIG.md](./NETWORK_CONFIG.md) - Детальная конфигурация сети
- [DEPLOYMENT.md](./DEPLOYMENT.md) - Руководство по развертыванию
- [README.md](./README.md) - Общая информация

